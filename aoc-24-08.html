<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>longcat defrag</title>
    </head>
    <body>
      <h1>mlep</h1>
      <p>Puzzle input: <input type="text" id="input" value="123456789807605403201"> <button id="go">go</button>
      </p>
      <canvas id="canvas"></canvas>
      <script>
const canvas = document.querySelector("#canvas");
const input = document.querySelector("#input");
const go = document.querySelector("#go");

const cat = (size, pos, catty, prev) => {
  const next = prev && prev.next;
  const res = { size: size, pos: pos, catty: catty, prev: prev, next: next };
  if (prev) { prev.next = res; }
  if (next) { next.prev = res; }
  return res;
};

let timer = null;

const movecat = (candidate, ct) => {
  if (!ct.catty) {
    return null;
  }
  while (candidate !== ct) {
    if (!candidate.catty && candidate.size >= ct.size) {
      candidate.size -= ct.size;
      const res = cat(ct.size, candidate.pos, ct.catty, candidate.prev);
      candidate.pos += ct.size;
      ct.catty = null;
      return res;
    }
    candidate = candidate.next;
  }
  return null;
};

const color = () => `#${(Math.random()*0xFFFFFF<<0).toString(16)}`;

go.onclick = () => {
  if (timer !== null) {
    clearTimeout(timer);
  }
  const first = cat(0, 0);
  let prev = first;
  let catty = true;
  let size = 0;
  for (const c of input.value) {
    const n = parseInt(c);
    if (!isNaN(n)) {
      prev = cat(n, size, catty && color(), prev);
      size += n;
      catty = !catty;
    }
  }
  const width = 14; // ((window.innerWidth - 32) >>> 3);
  const height = Math.ceil(size / width);

  const xy = (pos) => [pos % width, (pos / width) >>> 0];
  
  canvas.width = width << 3;
  canvas.height = height << 3;
  const ctx = canvas.getContext("2d");
  ctx.imageSmoothingEnabled = false;

  const anim = (fx, fy, tx, ty, catty, next) => {
    if (fx === tx && fy == ty) {
      timer = setTimeout(next);
      return;
    }
    if (fx < tx) { fx++; }
    if (fx > tx) { fx--; }
    if (fy < ty) { fy++; }
    if (fy > ty) { fy--; }
    ctx.fillText(catty, fx, fy);
    ctx.fillStyle = catty;
    timer = setTimeout(() => anim(fx, fy, tx, ty, catty, next), 10);
  };

  const defrag = (first, ct) => {
    if (ct === first) {
      return;
    }
    const prev = ct.prev;
    const next = () => defrag(first, prev);
    const res = movecat(first, ct);
    if (res) {
      const [fx, fy] = xy(ct.pos);
      const [tx, ty] = xy(res.pos);
      anim(fx * 8, fy * 8, tx * 8, ty * 8, res.catty, next);
    } else {
      timer = setTimeout(next);
    }
  };
  
  defrag(first, prev);
};


      </script>
    </body>
</html>
